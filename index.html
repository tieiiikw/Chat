<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LaamSocial - Wallet + Chat</title>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<!-- ethers.js for wallet generation -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
:root{
  --primary:#6c63ff; --primary-dark:#5a52d5; --dark:#2d3748; --light:#f8f9fa; --gray:#a0aec0;
  --sidebar-width:250px; --header-height:70px;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,system-ui,Roboto,'Helvetica Neue',Arial;}
body{background:#f5f7fb;color:var(--dark);line-height:1.5;}
header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;height:var(--header-height);display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;position:fixed;left:0;right:0;top:0;z-index:1000;}
header h2{font-size:1.2rem;font-weight:700;}
.header-right{display:flex;align-items:center;gap:0.75rem;}
.wallet-badge{display:flex;align-items:center;gap:0.6rem;background:rgba(255,255,255,0.1);padding:0.4rem 0.6rem;border-radius:20px;}
.wallet-address{font-weight:600;font-size:0.9rem;}
.copy-btn{background:transparent;border:0;color:#fff;cursor:pointer;}
.container-dashboard{display:flex;margin-top:var(--header-height);min-height:calc(100vh - var(--header-height));}
.sidebar{width:var(--sidebar-width);background:#fff;padding:1.2rem;position:fixed;height:calc(100vh - var(--header-height));overflow:auto;box-shadow:2px 0 8px rgba(0,0,0,0.05);}
.sidebar ul{list-style:none;}
.sidebar li{padding:0.8rem 0.6rem;cursor:pointer;display:flex;align-items:center;gap:0.6rem;border-radius:8px;}
.sidebar li:hover{background:rgba(108,99,255,0.06);color:var(--primary);}
.main-content{margin-left:var(--sidebar-width);flex:1;padding:1.5rem;}
section{background:#fff;border-radius:10px;padding:1rem;margin-bottom:1rem;display:none;}
section.active{display:block;}
.hidden{display:none!important;}
.login-container{display:flex;align-items:center;justify-content:center;height:80vh;}
.login-form{background:#fff;padding:1.5rem;border-radius:10px;width:100%;max-width:380px;box-shadow:0 8px 30px rgba(0,0,0,0.08);}
.form-group{margin-bottom:0.9rem;}
.form-control{width:100%;padding:0.6rem;border:1px solid #e6e9ef;border-radius:8px;}
.btn-primary{background:var(--primary);color:#fff;border:none;padding:0.7rem;border-radius:8px;width:100%;cursor:pointer;}
.profile-info{display:flex;flex-direction:column;gap:0.25rem;}
.wallet-panel{display:flex;flex-direction:column;gap:0.5rem;}
.balance-row{display:flex;gap:1rem;align-items:center;}
.balance-item{background:#f8f9ff;padding:0.6rem;border-radius:8px;min-width:140px;text-align:center;}
.small{font-size:0.85rem;color:var(--gray);} 
.token-label{font-weight:700;color:var(--primary);}
.copy-inline{cursor:pointer;background:#eee;border-radius:6px;padding:0.2rem 0.5rem;font-size:0.8rem;}
.upload-progress{height:8px;background:#e6e9ef;border-radius:8px;overflow:hidden;display:none;}
.upload-progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--primary-dark));}
.chat-messages{height:320px;overflow:auto;padding:0.6rem;}
@media(max-width:800px){.sidebar{display:none}.main-content{margin-left:0;padding:1rem}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer" class="login-container">
  <div class="login-form">
    <h2>LaamSocial</h2>
    <form id="loginForm">
      <div class="form-group"><label>Email</label><input id="loginEmail" class="form-control" type="email" required></div>
      <div class="form-group"><label>Password</label><input id="loginPassword" class="form-control" type="password" required></div>
      <button class="btn-primary" type="submit">Login</button>
      <div style="margin-top:0.6rem;text-align:center"><a href="#" id="showRegister">Create account</a></div>
      <div id="loginError" class="small" style="color:#d9534f;display:none;margin-top:0.6rem"></div>
    </form>
  </div>
</div>

<!-- REGISTER -->
<div id="registerContainer" class="login-container hidden">
  <div class="login-form">
    <h2>Create Account</h2>
    <form id="registerForm">
      <div class="form-group"><label>Full name</label><input id="registerName" class="form-control" type="text" required></div>
      <div class="form-group"><label>Email</label><input id="registerEmail" class="form-control" type="email" required></div>
      <div class="form-group"><label>Password</label><input id="registerPassword" class="form-control" type="password" required></div>
      <div class="form-group"><label>Confirm</label><input id="confirmPassword" class="form-control" type="password" required></div>
      <button class="btn-primary" type="submit">Register</button>
      <div style="margin-top:0.6rem;text-align:center"><a href="#" id="showLogin">Already have account? Login</a></div>
      <div id="registerError" class="small" style="color:#d9534f;display:none;margin-top:0.6rem"></div>
    </form>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardContainer" class="hidden">
  <header>
    <h2>LaamSocial</h2>
    <div class="header-right">
      <div class="wallet-badge" id="walletBadge">
        <i class="fas fa-wallet"></i>
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
          <div class="wallet-address" id="walletAddressDisplay">—</div>
          <div class="small" id="walletMini">BNB: — | USDT: —</div>
        </div>
        <button class="copy-btn" id="copyWalletBtn" title="Copy address"><i class="fas fa-copy"></i></button>
      </div>
      <div style="color:#fff" id="userEmailDisplay"></div>
      <button id="logoutBtn" class="btn-primary" style="background:transparent;border:1px solid rgba(255,255,255,0.2);padding:0.4rem 0.6rem;">Logout</button>
    </div>
  </header>

  <div class="container-dashboard">
    <nav class="sidebar">
      <ul>
        <li data-section="homeSection" class="active"><i class="fas fa-home"></i><span> Home</span></li>
        <li data-section="friendsSection"><i class="fas fa-user-friends"></i><span> Friends</span></li>
        <li data-section="messagesSection"><i class="fas fa-comments"></i><span> Messages</span></li>
        <li data-section="walletSection"><i class="fas fa-wallet"></i><span> Wallet</span></li>
        <li data-section="notificationsSection"><i class="fas fa-bell"></i><span> Notifications</span></li>
        <li data-section="profileSection"><i class="fas fa-user-cog"></i><span> Profile</span></li>
      </ul>
    </nav>

    <main class="main-content">
      <!-- HOME -->
      <section id="homeSection" class="active">
        <h3>Home Feed</h3>
        <div id="postSection">
          <textarea id="postText" class="form-control" placeholder="What's on your mind?" rows="4"></textarea>
          <div style="display:flex;gap:0.6rem;margin-top:0.6rem;align-items:center;">
            <label for="postImage" class="small" style="cursor:pointer"><i class="fas fa-image"></i> Add Image</label>
            <input id="postImage" type="file" accept="image/*" style="display:none" />
            <button id="postBtn" class="btn-primary" style="max-width:140px">Post</button>
          </div>
          <div class="upload-progress" id="uploadProgress"><div id="uploadProgressBar"></div></div>
        </div>
        <div id="feed" style="margin-top:1rem;"></div>
      </section>

      <!-- FRIENDS -->
      <section id="friendsSection"><h3>Friends</h3><div id="friendsList" class="friends-grid"></div></section>

      <!-- MESSAGES -->
      <section id="messagesSection">
        <h3>Messages</h3>
        <div style="display:flex;gap:1rem;">
          <div style="width:280px;background:#f8f9ff;padding:0.8rem;border-radius:8px;">
            <div id="conversationsList"></div>
          </div>
          <div style="flex:1;">
            <div style="background:#fff;padding:0.8rem;border-radius:8px;margin-bottom:0.6rem;">
              <div style="display:flex;gap:0.8rem;align-items:center;">
                <div style="width:44px;height:44px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff" id="chatUserAvatar">?</div>
                <div>
                  <div id="chatUserName">Select a conversation</div>
                  <div class="small" id="chatUserStatus"></div>
                </div>
              </div>
            </div>
            <div class="chat-messages" id="chatBox" style="background:#fff;border-radius:8px;padding:0.6rem;"></div>
            <div style="display:flex;gap:0.6rem;margin-top:0.6rem;">
              <input id="chatInput" class="form-control" type="text" placeholder="Type a message..." disabled />
              <button id="sendBtn" class="btn-primary" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- WALLET -->
      <section id="walletSection">
        <h3>Wallet</h3>
        <div class="wallet-panel">
          <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
            <div class="balance-item">
              <div class="small">Main balance</div>
              <div style="font-weight:700;font-size:1.05rem" id="bnbBalance">— BNB</div>
              <div class="small" id="bnbFiat">—</div>
            </div>
            <div class="balance-item">
              <div class="small">USDT (BEP20)</div>
              <div style="font-weight:700;font-size:1.05rem" id="usdtBalance">—</div>
              <div class="small" id="usdtFiat">—</div>
            </div>
          </div>

          <div style="display:flex;gap:0.6rem;align-items:center;margin-top:0.6rem;">
            <div class="small">Address</div>
            <div class="copy-inline" id="walletAddressShort">—</div>
            <button id="copyBtn" class="btn-primary" style="max-width:120px">Copy address</button>
            <button id="depositTelebirr" class="btn-primary" style="max-width:160px;background:#00a3ff">Deposit (Telebirr)</button>
          </div>

          <div style="margin-top:0.6rem;">
            <small class="small">Private key is stored only in your browser (LocalStorage).</small>
          </div>
        </div>
      </section>

      <!-- NOTIFICATIONS -->
      <section id="notificationsSection"><h3>Notifications</h3><div id="notificationsList"></div></section>

      <!-- PROFILE -->
      <section id="profileSection">
        <h3>Profile</h3>
        <div style="display:flex;gap:1rem;align-items:center;">
          <img id="profilePicDisplay" src="https://via.placeholder.com/80" width="80" height="80" style="border-radius:12px;object-fit:cover"/>
          <div class="profile-info">
            <div id="profileName">Loading...</div>
            <div id="profileEmail">Loading...</div>
            <div class="small" id="memberSince">Member since —</div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Telebirr Modal (simple) -->
<div id="telebirrModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:1rem;border-radius:10px;max-width:520px;width:95%;">
    <h4>Deposit via Telebirr</h4>
    <p id="telebirrInstructions">Replace this with your Telebirr instructions or payment flow.</p>
    <div style="display:flex;gap:0.6rem;justify-content:flex-end;margin-top:0.8rem;">
      <button id="telebirrClose" class="btn-primary" style="background:#ddd;color:#000">Close</button>
    </div>
  </div>
</div>

<script>
/* =============================
  Configuration - update if needed
   ============================= */
const firebaseConfig = {
  apiKey: "AIzaSyDy_GTVZvwCZp8eLYvd_TUPI-uo_Jp5MpY",
  authDomain: "laamsocial-98cce.firebaseapp.com",
  projectId: "laamsocial-98cce",
  storageBucket: "laamsocial-98cce.appspot.com",
  messagingSenderId: "649707204234",
  appId: "1:649707204234:web:2f22441b4dbbacc5674773"
};

const CLOUDINARY_CLOUD_NAME = "dwbcovoit";
const CLOUDINARY_UPLOAD_PRESET = "laamsocial_upload";

/* BscScan API key - replace with your key */
const BSCSCAN_API_KEY = "REPLACE_WITH_BSCSCAN_API_KEY";

/* USDT token contract on BSC (BEP20) */
const USDT_CONTRACT = "0x55d398326f99059fF775485246999027B3197955"; // common BSC USDT

/* =============================
  Initialize Firebase and services
   ============================= */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* DOM refs */
const loginContainer = document.getElementById('loginContainer');
const registerContainer = document.getElementById('registerContainer');
const dashboardContainer = document.getElementById('dashboardContainer');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const showRegister = document.getElementById('showRegister');
const showLogin = document.getElementById('showLogin');
const logoutBtn = document.getElementById('logoutBtn');
const userEmailDisplay = document.getElementById('userEmailDisplay');
const walletAddressDisplay = document.getElementById('walletAddressDisplay');
const walletAddressShort = document.getElementById('walletAddressShort');
const walletMini = document.getElementById('walletMini');
const copyWalletBtn = document.getElementById('copyWalletBtn');
const copyBtn = document.getElementById('copyBtn');
const postBtn = document.getElementById('postBtn');
const postText = document.getElementById('postText');
const postImage = document.getElementById('postImage');
const uploadProgress = document.getElementById('uploadProgress');
const uploadProgressBar = document.getElementById('uploadProgressBar');

const feed = document.getElementById('feed');
const friendsList = document.getElementById('friendsList');
const conversationsList = document.getElementById('conversationsList');
const chatBox = document.getElementById('chatBox');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const chatUserName = document.getElementById('chatUserName');
const chatUserAvatar = document.getElementById('chatUserAvatar');
const chatUserStatus = document.getElementById('chatUserStatus');
const bnbBalanceEl = document.getElementById('bnbBalance');
const usdtBalanceEl = document.getElementById('usdtBalance');
const bnbFiatEl = document.getElementById('bnbFiat');
const usdtFiatEl = document.getElementById('usdtFiat');
const depositTelebirr = document.getElementById('depositTelebirr');
const telebirrModal = document.getElementById('telebirrModal');
const telebirrClose = document.getElementById('telebirrClose');
const telebirrInstructions = document.getElementById('telebirrInstructions');

const profileNameEl = document.getElementById('profileName');
const profileEmailEl = document.getElementById('profileEmail');
const memberSinceEl = document.getElementById('memberSince');
const profilePicDisplay = document.getElementById('profilePicDisplay');

/* State */
let currentUser = null;
let chatListener = null;
let selectedUserId = null;
let selectedChatId = null;

/* ===== Helpers ===== */
function toDateSafe(value){
  if(!value) return new Date();
  if(value.toDate && typeof value.toDate === 'function') return value.toDate();
  if(value instanceof Date) return value;
  return new Date(value);
}
function formatDate(d){
  const date = toDateSafe(d);
  return date.toLocaleString();
}
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function shortAddress(addr){ if(!addr) return '—'; return addr.substring(0,6)+'...'+addr.substring(addr.length-4); }
function setWalletUI(address){
  walletAddressDisplay.textContent = address || '—';
  walletAddressShort.textContent = address ? shortAddress(address) : '—';
  walletMini.textContent = 'BNB: — | USDT: —';
}

/* ===== Cloudinary upload (provided) ===== */
async function uploadToCloudinary(file){
  return new Promise((resolve,reject)=>{
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    uploadProgress.style.display = 'block';
    const xhr = new XMLHttpRequest();
    xhr.upload.addEventListener('progress', (e) => {
      if(e.lengthComputable){
        const percent = (e.loaded / e.total) * 100;
        uploadProgressBar.style.width = percent + '%';
      }
    });
    xhr.addEventListener('load', ()=> {
      uploadProgress.style.display = 'none';
      if(xhr.status === 200){
        const response = JSON.parse(xhr.responseText);
        resolve(response.secure_url);
      } else reject(new Error('Upload failed'));
    });
    xhr.addEventListener('error', ()=>{ uploadProgress.style.display='none'; reject(new Error('Upload failed')); });
    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`);
    xhr.send(formData);
  });
}

/* ===== BSC utilities: get BNB and token balances via BscScan REST API =====
   Note: requires BSCSCAN_API_KEY. Replace placeholder with your key.
*/
async function fetchBnbBalance(address){
  if(!BSCSCAN_API_KEY) return null;
  try{
    const url = `https://api.bscscan.com/api?module=account&action=balance&address=${address}&tag=latest&apikey=${BSCSCAN_API_KEY}`;
    const res = await fetch(url);
    const j = await res.json();
    if(j.status === "1") {
      const wei = BigInt(j.result);
      const bnb = Number(wei) / 1e18;
      return bnb;
    }
  }catch(e){}
  return null;
}

async function fetchTokenBalance(address, tokenContract){
  if(!BSCSCAN_API_KEY) return null;
  try{
    const url = `https://api.bscscan.com/api?module=account&action=tokenbalance&contractaddress=${tokenContract}&address=${address}&tag=latest&apikey=${BSCSCAN_API_KEY}`;
    const res = await fetch(url);
    const j = await res.json();
    if(j.status === "1"){
      // many tokens have 18 decimals; USDT on BSC often 18 or 18-equivalent (on BSC USDT is 18)
      const raw = BigInt(j.result);
      const tokenAmount = Number(raw) / 1e18;
      return tokenAmount;
    }
  }catch(e){}
  return null;
}

/* Optional: approximate USD price via Coingecko (no key). For brevity we'll skip multiple sources.
   But we show fiat only if we can fetch price.
*/
async function fetchBnbPriceUsd(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
    const j = await r.json();
    return j?.binancecoin?.usd || null;
  }catch(e){ return null; }
}

/* ===== Wallet generation (ethers.js) - auto generate on register =====
   Private key stored ONLY in localStorage under key: laam_privateKey_{uid}
   Firestore stores only the address at users/{uid}.walletAddress
*/
function savePrivateKeyToLocal(uid, privateKey){
  try{ localStorage.setItem(`laam_privateKey_${uid}`, privateKey); }catch(e){}
}
function getPrivateKeyFromLocal(uid){
  try{ return localStorage.getItem(`laam_privateKey_${uid}`); }catch(e){ return null; }
}

function createBscWalletForUser(uid){
  // Generate random wallet
  const wallet = ethers.Wallet.createRandom();
  const privateKey = wallet.privateKey; // 0x...
  const address = wallet.address;
  // Save private key to localStorage
  savePrivateKeyToLocal(uid, privateKey);
  // Save address to Firestore
  return  db.collection('users').doc(uid).set({
    walletAddress: address
  }, { merge: true }).then(()=> address).catch(()=> null);
}

/* ===== Auth state observer ===== */
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    showDashboard();
    userEmailDisplay.textContent = user.email || '';
    loadUserData();
    loadPosts();
    loadFriends();
    loadConversations();
    loadNotifications();
    ensureWalletExists(user);
  } else {
    currentUser = null;
    showLoginForm();
  }
});

/* ===== UI switchers ===== */
function showLoginForm(){ loginContainer.classList.remove('hidden'); registerContainer.classList.add('hidden'); dashboardContainer.classList.add('hidden'); }
function showRegisterForm(){ loginContainer.classList.add('hidden'); registerContainer.classList.remove('hidden'); dashboardContainer.classList.add('hidden'); }
function showDashboard(){ loginContainer.classList.add('hidden'); registerContainer.classList.add('hidden'); dashboardContainer.classList.remove('hidden'); }

/* ===== Ensure wallet exists for user (auto-generate) ===== */
async function ensureWalletExists(user){
  if(!user) return;
  const docRef = db.collection('users').doc(user.uid);
  try{
    const snap = await docRef.get();
    if(snap.exists){
      const data = snap.data();
      if(data && data.walletAddress){
        setWalletUI(data.walletAddress);
        startBalancePolling(data.walletAddress);
        return;
      }
    }
    // create wallet and store address
    const address = await createBscWalletForUser(user.uid);
    if(address){
      setWalletUI(address);
      startBalancePolling(address);
    } else {
      setWalletUI(null);
    }
  }catch(e){
    setWalletUI(null);
  }
}

/* ===== Balance polling (BNB + USDT) ===== */
let balanceInterval = null;
function startBalancePolling(address){
  // update UI immediately and poll every 30s
  updateBalances(address);
  if(balanceInterval) clearInterval(balanceInterval);
  balanceInterval = setInterval(()=> updateBalances(address), 30000);
}

async function updateBalances(address){
  if(!address) return;
  setWalletUI(address);
  // show loading placeholders
  bnbBalanceEl.textContent = '— BNB';
  usdtBalanceEl.textContent = '—';
  bnbFiatEl.textContent = '';
  usdtFiatEl.textContent = '';
  // fetch balances
  const [bnb, usdt, bnbPrice] = await Promise.all([
    fetchBnbBalance(address),
    fetchTokenBalance(address, USDT_CONTRACT),
    fetchBnbPriceUsd()
  ]);
  if(typeof bnb === 'number' && !Number.isNaN(bnb)) {
    bnbBalanceEl.textContent = `${bnb.toFixed(6)} BNB`;
    if(bnbPrice) bnbFiatEl.textContent = `≈ $${(bnb * bnbPrice).toFixed(2)}`;
  } else {
    bnbBalanceEl.textContent = '0 BNB';
  }
  if(typeof usdt === 'number' && !Number.isNaN(usdt)) {
    usdtBalanceEl.textContent = `${usdt.toFixed(6)} USDT`;
    // USDT ≈ USD
    usdtFiatEl.textContent = `≈ $${usdt.toFixed(2)}`;
  } else {
    usdtBalanceEl.textContent = '0';
  }
  walletMini.textContent = `BNB: ${bnb ? bnb.toFixed(6) : '0'} | USDT: ${usdt ? usdt.toFixed(6) : '0'}`;
}

/* ===== Load user data (profile) ===== */
function loadUserData(){
  const docRef = db.collection('users').doc(currentUser.uid);
  docRef.get().then(doc=>{
    if(doc.exists){
      const d = doc.data();
      profileNameEl.textContent = d.name || currentUser.displayName || 'User';
      profileEmailEl.textContent = currentUser.email || d.email || '';
      memberSinceEl.textContent = d.createdAt ? formatDate(d.createdAt) : '—';
      if(d.profilePic) profilePicDisplay.src = d.profilePic;
      if(d.walletAddress) setWalletUI(d.walletAddress);
    } else {
      profileNameEl.textContent = currentUser.displayName || 'User';
      profileEmailEl.textContent = currentUser.email || '';
    }
  }).catch(()=>{/* silent */});
}

/* ===== Posts load + create ===== */
function createPostElement(post, id){
  const el = document.createElement('div');
  el.className = 'post';
  const author = escapeHtml(post.authorName || 'User');
  const text = escapeHtml(post.text || '');
  const img = post.imageUrl ? `<img src="${post.imageUrl}" style="max-width:100%;border-radius:8px;margin-top:0.6rem"/>` : '';
  const time = post.createdAt ? formatDate(post.createdAt) : '';
  el.innerHTML = `<div style="display:flex;gap:0.6rem;align-items:center;margin-bottom:0.4rem;">
    <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff">${author.substring(0,2).toUpperCase()}</div>
    <div><div style="font-weight:700">${author}</div><div class="small">${time}</div></div>
  </div>
  <div>${text}${img}</div>`;
  return el;
}

function loadPosts(){
  db.collection('posts').orderBy('createdAt','desc').limit(30).onSnapshot(snapshot=>{
    feed.innerHTML = '';
    if(snapshot.empty) {
      feed.innerHTML = `<div class="small">No posts yet.</div>`;
      return;
    }
    snapshot.forEach(doc=>{
      const post = doc.data();
      feed.appendChild(createPostElement(post, doc.id));
    });
  }, ()=>{ feed.innerHTML = `<div class="small">Unable to load posts.</div>`; });
}

/* Post creation with optional image upload to Cloudinary */
postBtn.addEventListener('click', async ()=>{
  const text = postText.value.trim();
  const file = postImage.files && postImage.files[0];
  if(!text && !file) return alert('Enter text or choose an image.');
  let imageUrl = null;
  try{
    if(file) imageUrl = await uploadToCloudinary(file);
    await db.collection('posts').add({
      text,
      imageUrl,
      authorId: currentUser.uid,
      authorName: currentUser.displayName || profileNameEl.textContent || 'User',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    postText.value = '';
    postImage.value = '';
  }catch(e){
    alert('Error creating post.');
  }
});

/* ===== Friends - fetch all users and filter locally ===== */
function loadFriends(){
  db.collection('users').limit(200).get().then(snapshot=>{
    friendsList.innerHTML = '';
    if(snapshot.empty){ friendsList.innerHTML = '<div class="small">No users found.</div>'; return;}
    snapshot.forEach(doc=>{
      const user = doc.data();
      if(!user || user.uid === currentUser.uid) return;
      const card = document.createElement('div');
      card.className = 'friend-card';
      const name = escapeHtml(user.name || 'User');
      const initials = name.split(' ').map(p=>p[0]).join('').toUpperCase().substring(0,2);
      card.innerHTML = `<div style="padding:1rem;"><div style="width:60px;height:60px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;margin-bottom:0.4rem">${initials}</div>
        <div style="font-weight:700">${name}</div>
        <div class="small" style="margin-top:0.4rem">${shortAddress(user.walletAddress||'—')}</div>
        <div style="display:flex;gap:0.4rem;margin-top:0.6rem;justify-content:center">
          <button class="btn-primary messageBtn" data-uid="${user.uid}">Message</button>
        </div>
      </div>`;
      friendsList.appendChild(card);
    });
    // attach message buttons
    document.querySelectorAll('.messageBtn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const uid = btn.dataset.uid;
        // fetch user doc quickly
        const doc = await db.collection('users').doc(uid).get();
        if(!doc.exists) return alert('User not found');
        const u = doc.data();
        startChatWithUser(u);
        // switch to messages section
        document.querySelectorAll('.sidebar li').forEach(li=>li.classList.remove('active'));
        document.querySelector('[data-section="messagesSection"]').classList.add('active');
        document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
        document.getElementById('messagesSection').classList.add('active');
      });
    });
  }).catch(()=>{ friendsList.innerHTML = '<div class="small">Unable to load users.</div>'; });
}

/* ===== Conversations (list of users) ===== */
function loadConversations(){
  db.collection('users').limit(50).get().then(snapshot=>{
    conversationsList.innerHTML = '';
    snapshot.forEach(doc=>{
      const u = doc.data();
      if(!u || u.uid === currentUser.uid) return;
      const el = document.createElement('div');
      el.style.padding = '0.4rem';
      el.style.cursor = 'pointer';
      el.innerHTML = `<div style="display:flex;gap:0.6rem;align-items:center;">
        <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff">${(u.name||'U').substring(0,2).toUpperCase()}</div>
        <div><div style="font-weight:700">${escapeHtml(u.name||'User')}</div><div class="small">Click to chat</div></div>
      </div>`;
      el.addEventListener('click', ()=> startChatWithUser(u));
      conversationsList.appendChild(el);
    });
  }).catch(()=>{ conversationsList.innerHTML = '<div class="small">Unable to load conversations.</div>'; });
}

/* ===== Chat functions ===== */
function startChatWithUser(user){
  selectedUserId = user.uid;
  chatUserName.textContent = user.name || 'User';
  chatUserAvatar.textContent = (user.name||'U').substring(0,2).toUpperCase();
  chatUserStatus.textContent = 'Online';
  chatInput.disabled = false; sendBtn.disabled = false;
  if(chatListener) chatListener(); // detach
  const chatId = [currentUser.uid, user.uid].sort().join('_');
  selectedChatId = chatId;
  loadChatMessages(chatId);
}

function createMessageElement(message){
  const el = document.createElement('div');
  const isSent = message.senderId === currentUser.uid;
  el.style.margin = '0.4rem 0';
  el.style.alignSelf = isSent ? 'flex-end' : 'flex-start';
  el.style.background = isSent ? 'var(--primary)' : '#f1f3f9';
  el.style.color = isSent ? '#fff' : '#000';
  el.style.padding = '0.6rem'; el.style.borderRadius = '8px'; el.style.maxWidth = '70%';
  const time = message.timestamp ? formatDate(message.timestamp) : '';
  el.innerHTML = `<div>${escapeHtml(message.text)}</div><div class="small" style="opacity:0.8;margin-top:0.3rem;text-align:right">${time}</div>`;
  return el;
}

function loadChatMessages(chatId){
  chatBox.innerHTML = '';
  const chatRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp','asc');
  chatListener = chatRef.onSnapshot(snapshot=>{
    chatBox.innerHTML = '';
    if(snapshot.empty){
      chatBox.innerHTML = '<div class="small">No messages yet.</div>';
      return;
    }
    snapshot.forEach(doc=>{
      chatBox.appendChild(createMessageElement(doc.data()));
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }, ()=>{ chatBox.innerHTML = '<div class="small">Unable to load messages.</div>'; });
}

/* send message */
sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') sendMessage(); });

function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !selectedChatId) return;
  db.collection('chats').doc(selectedChatId).collection('messages').add({
    text,
    senderId: currentUser.uid,
    senderName: currentUser.displayName || profileNameEl.textContent || 'User',
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{ chatInput.value = ''; }).catch(()=>{ alert('Error sending message.'); });
}

/* ===== Notifications (demo) ===== */
function loadNotifications(){
  const notifications = [
    {type:'like',title:'Someone liked your post', time: new Date()},
    {type:'friend',title:'New friend joined', time: new Date(Date.now()-3600*1000)}
  ];
  const list = document.getElementById('notificationsList');
  list.innerHTML = '';
  notifications.forEach(n=>{
    const el = document.createElement('div'); el.className = 'notification';
    el.innerHTML = `<div style="display:flex;gap:0.6rem;align-items:center"><div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff">${n.title[0]}</div>
      <div><div style="font-weight:700">${escapeHtml(n.title)}</div><div class="small">${formatDate(n.time)}</div></div></div>`;
    list.appendChild(el);
  });
}

/* ===== Register/Login handlers ===== */
loginForm.addEventListener('submit', (e)=>{ e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError'); err.style.display='none';
  auth.signInWithEmailAndPassword(email, password).catch(errx=>{
    err.textContent = 'Login failed: ' + (errx.message || 'Check credentials'); err.style.display='block';
  });
});

registerForm.addEventListener('submit', async (e)=>{ e.preventDefault();
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const err = document.getElementById('registerError'); err.style.display='none';
  if(password !== confirmPassword){ err.textContent='Passwords do not match'; err.style.display='block'; return; }
  try{
    const uc = await auth.createUserWithEmailAndPassword(email,password);
    const user = uc.user;
    await user.updateProfile({ displayName: name });
    // create user doc + auto-create BSC wallet address and save to Firestore
    const wallet = ethers.Wallet.createRandom();
    const privateKey = wallet.privateKey;
    const address = wallet.address;
    // Save private key in localStorage (only)
    savePrivateKeyToLocal(user.uid, privateKey);
    await db.collection('users').doc(user.uid).set({
      uid: user.uid,
      name,
      email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      walletAddress: address
    });
    // show dashboard automatically (auth observer will fire)
  }catch(errx){
    err.textContent = 'Registration failed: ' + (errx.message || 'Try again'); err.style.display='block';
  }
});

/* ===== Logout ===== */
logoutBtn.addEventListener('click', ()=> auth.signOut());

/* ===== Copy address handlers ===== */
copyBtn.addEventListener('click', ()=> {
  const addr = walletAddressDisplay.textContent;
  if(!addr) return alert('No address to copy');
  navigator.clipboard.writeText(addr).then(()=> alert('Address copied'));
});
copyWalletBtn.addEventListener('click', ()=> {
  const addr = walletAddressDisplay.textContent;
  if(!addr) return;
  navigator.clipboard.writeText(addr).then(()=>{/* silent */});
});

/* ===== Telebirr modal (simple instructions) ===== */
depositTelebirr.addEventListener('click', ()=>{
  telebirrInstructions.textContent = 'REPLACE_WITH_TELEBIRR_INSTRUCTION — e.g., Send money to X account and include your wallet address in the message. Or integrate a backend to accept Telebirr callbacks.';
  telebirrModal.classList.remove('hidden');
});
telebirrClose.addEventListener('click', ()=> telebirrModal.classList.add('hidden'));

/* ===== Menu navigation ===== */
document.querySelectorAll('.sidebar li').forEach(li=>{
  li.addEventListener('click', function(){
    document.querySelectorAll('.sidebar li').forEach(i=>i.classList.remove('active'));
    this.classList.add('active');
    const target = this.dataset.section;
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(target).classList.add('active');
  });
});
document.getElementById('showRegister').addEventListener('click', (e)=>{ e.preventDefault(); showRegisterForm(); });
document.getElementById('showLogin').addEventListener('click', (e)=>{ e.preventDefault(); showLoginForm(); });

/* ===== window unload: update lastSeen ===== */
window.addEventListener('beforeunload', ()=>{
  if(currentUser) db.collection('users').doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
});

/* ===== Initialize small parts ===== */
function init(){
  // Placeholder UI
  setWalletUI(null);
  loadNotifications();
}
init();

</script>
</body>
</html>